<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyPlanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee; --secondary: #3f37c9; --accent: #4895ef;
            --light: #f8f9fa; --dark: #212529; --danger: #f72585;
            --card-header-bg: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            --header-animation: none;
        }
        @keyframes animated-gradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        @keyframes subtle-glow { 0%,100%{box-shadow:0 0 5px 0px var(--primary)} 50%{box-shadow:0 0 15px 3px var(--primary)} }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; color: var(--dark); }
        .app-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.1); overflow: hidden; }

        .header { background: var(--primary); color: white; padding: 25px; text-align: center; transition: background 0.3s ease; animation: var(--header-animation); background-size: 200% 200%; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .app-content { display: flex; min-height: 600px; }
        .sidebar { width: 250px; background: var(--light); padding: 20px; border-right: 1px solid #e9ecef; }
        .user-profile { text-align: center; margin-bottom: 30px; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 15px; cursor: pointer; }
        .user-name { font-weight: 600; font-size: 1.1rem; }
        .nav-menu { list-style: none; padding: 0; }
        .nav-item { margin-bottom: 8px; }
        .nav-item .nav-link { display: flex; align-items: center; padding: 10px 15px; color: var(--dark); text-decoration: none; font-weight: 500; border-radius: 8px; transition: all 0.2s ease; cursor: pointer; }
        .nav-item .nav-link:hover { background: rgba(67, 97, 238, 0.1); }
        .nav-item.active .nav-link { background: var(--primary); color: white; }
        .nav-link i { margin-right: 10px; font-size: 1rem; width: 20px; text-align: center; }

        .main-content { flex: 1; padding: 25px; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }
        .dashboard-title { font-size: 1.5rem; font-weight: 600; }
        .subjects-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .subject-card { background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #e9ecef; display: flex; flex-direction: column; }
        .subject-header { padding: 15px; background: var(--card-header-bg); color: white; display: flex; align-items: center; text-align: center; background-size: 200% 200%; animation: var(--header-animation); position: relative; }
        .subject-title-group { flex-grow: 1; }
        .subject-header h3 { font-size: 1.2rem; margin: 0; font-weight: 600; }
        .subject-time { background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; display: inline-block; margin-top: 5px; }
        
        .subject-actions { position: absolute; top: 10px; right: 10px; }
        .action-menu-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1rem; opacity: 0.8; transition: opacity 0.2s ease; padding: 5px; }
        .action-menu-btn:hover { opacity: 1; }
        .actions-menu { display: none; position: absolute; top: 30px; right: 0; background: white; color: var(--dark); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 10; overflow: hidden; }
        .actions-menu a { display: block; padding: 10px 15px; text-decoration: none; color: var(--dark); font-size: 0.9rem; white-space: nowrap; }
        .actions-menu a:hover { background: var(--light); }
        .actions-menu a i { margin-right: 8px; }
        .actions-menu .delete-action { color: var(--danger); }
        
        .subject-body { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .task-list { list-style: none; flex: 1; }
        .task-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f5; }
        .task-label { flex: 1; font-size: 0.9rem; }
        .task-label.completed { text-decoration: line-through; color: #6c757d; }
        .delete-task-btn { background: none; border: none; color: #adb5bd; cursor: pointer; opacity: 0; visibility: hidden; transition: all 0.2s ease; font-size: 1rem; }
        .task-item:hover .delete-task-btn { opacity: 1; visibility: visible; color: var(--danger); }
        .add-task-form { display: none; margin-top: 15px; }
        .task-input { flex: 1; padding: 8px 12px; border: 1px solid #e9ecef; border-radius: 6px 0 0 6px; font-size: 0.9rem; outline: none; }
        .add-task-btn { background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 0 6px 6px 0; cursor: pointer; transition: background 0.2s ease; }
        .add-task-btn:hover { background: var(--secondary); }
        .show-add-task-btn { background: none; border: 1px dashed #ccc; color: #6c757d; width: 100%; padding: 8px; margin-top: 15px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
        .show-add-task-btn:hover { background: var(--light); color: var(--primary); border-color: var(--primary); }
        
        .add-subject-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 1.5rem; box-shadow: 0 5px 20px rgba(67, 97, 238, 0.4); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; z-index: 10; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.3rem; font-weight: 600; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d; }
        .form-input, input[type="time"] { width: 100%; padding: 10px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 0.9rem; font-family: 'Poppins', sans-serif; }
        .time-inputs { display: flex; gap: 15px; align-items: center;}
        .submit-btn, .setting-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; width: 100%; margin-top: 10px; transition: background 0.2s ease; text-align: center; }
        
        .settings-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
        .settings-section h4 { font-weight: 600; margin-bottom: 15px; color: var(--dark); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; max-height: 250px; overflow-y: auto; padding: 5px; }
        .theme-option { cursor: pointer; padding: 10px; border-radius: 8px; border: 2px solid transparent; transition: border-color 0.2s ease; background: var(--light); }
        .theme-option.active { border-color: var(--primary); animation: subtle-glow 2s infinite ease-in-out; }
        .theme-name { font-weight: 600; font-size: 0.9rem; }
        
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
        .week-days, .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 5px; }
        .week-days div { font-weight: 600; color: #999; }
        .calendar-day { padding: 10px; border-radius: 5px; cursor: pointer; transition: all 0.2s; position: relative; }
        .calendar-day.other-month { color: #ccc; cursor: default; }
        .calendar-day:not(.other-month):hover { background: #eee; }
        .calendar-day.has-subject::after { content: ''; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background: var(--primary); border-radius: 50%; }
        .calendar-day.selected { background: var(--primary); color: white; font-weight: 600; }

        #print-area, #import-file-input, #avatar-upload { display: none; }
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #print-area, #print-area * { display: block !important; visibility: visible !important; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; font-size: 10pt; }
            #print-area h1 { text-align: center; font-size: 1.5rem; color: #333; margin-bottom: 5px; }
            #print-area h2 { font-size: 1.2rem; background: #eee !important; color: #333 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; padding: 8px; border-radius: 5px; margin-top: 15px; margin-bottom: 10px; }
            .print-subject-card { border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; padding: 10px; page-break-inside: avoid; }
            .print-subject-header { display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px; }
            .print-task-list { list-style: none; padding-left: 5px; }
            .print-task-item::before { content: '☐'; font-size: 1rem; margin-right: 8px; }
            .print-task-item.completed::before { content: '☑'; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header"><h1>StudyPlanner by MP Salodiya</h1></header>
        <div class="app-content">
            <aside class="sidebar">
                <div class="user-profile"><img src="" alt="User" class="avatar" title="Click to change photo"><div class="user-name"></div></div>
                <ul class="nav-menu">
                    <li class="nav-item active" data-view="dashboard"><a class="nav-link"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
                    <li class="nav-item" data-view="schedule"><a class="nav-link"><i class="fas fa-calendar-alt"></i><span>Schedule</span></a></li>
                    <li class="nav-item"><a class="nav-link" id="print-btn-nav"><i class="fas fa-print"></i><span>Print Plan</span></a></li>
                    <li class="nav-item"><a class="nav-link" id="settings-btn"><i class="fas fa-cog"></i><span>Settings</span></a></li>
                </ul>
            </aside>
            <main class="main-content">
                <div id="dashboard-view">
                    <div class="dashboard-header"><h2 class="dashboard-title">Subjects for: <span id="current-date-display"></span></h2></div>
                    <div class="subjects-container" id="subjects-container"></div>
                </div>
                <div id="schedule-view" style="display: none;">
                    <div class="calendar">
                        <div class="calendar-header"><button id="prev-month" class="calendar-nav">&lt;</button><h3 id="month-year"></h3><button id="next-month" class="calendar-nav">&gt;</button></div>
                        <div class="week-days"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                        <div class="calendar-days" id="calendar-days"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <button class="add-subject-btn" id="add-subject-btn" title="Add New Subject"><i class="fas fa-plus"></i></button>

    <div class="modal" id="subject-modal">
        <div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="modal-title"></h3><button class="close-btn">&times;</button></div><form id="subject-form"><input type="hidden" id="subject-id"><div class="form-group"><label for="subject-name">Subject Name</label><input type="text" id="subject-name" class="form-input" required></div><div class="form-group"><label>Time Duration</label><div class="time-inputs"><div><label for="subject-start-time" style="font-size:0.8rem;">Start Time</label><input type="time" id="subject-start-time" required></div><div><label for="subject-end-time" style="font-size:0.8rem;">End Time</label><input type="time" id="subject-end-time" required></div></div></div><button type="submit" class="submit-btn" id="submit-btn"></button></form></div>
    </div>
    <div class="modal" id="settings-modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Settings</h3><button class="close-btn">&times;</button></div><div id="settings-content"></div></div></div>
    <div class="modal" id="print-modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Print Options</h3><button class="close-btn">&times;</button></div><div class="print-options"><button class="submit-btn print-btn" data-mode="selected">Print Selected Date's Plan</button><button class="submit-btn print-btn" data-mode="all">Print Full Schedule</button></div></div></div>
    
    <div id="print-area"></div>
    <input type="file" id="import-file-input" accept=".json">
    <input type="file" id="avatar-upload" accept="image/*">

    <script>
    // =================================================================================
    // SCRIPT START
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // =================================================================================
        // GLOBAL STATE & DOM ELEMENTS
        // =================================================================================
        let schedule = {};
        let userProfile = {};
        let currentDate = new Date();
        let calendarDate = new Date();

        const mainContent = document.querySelector('.main-content');
        const subjectModal = document.getElementById('subject-modal');
        const settingsModal = document.getElementById('settings-modal');
        const printModal = document.getElementById('print-modal');

        // =================================================================================
        // UTILITY FUNCTIONS
        // =================================================================================
        const formatDate = date => [date.getFullYear(), (date.getMonth() + 1).toString().padStart(2, '0'), date.getDate().toString().padStart(2, '0')].join('-');
        
        const formatTimeForDisplay = (time24) => {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes.padStart(2, '0')} ${ampm}`;
        };

        const formatTimeForInput = (time12) => {
            if (!time12) return '';
            const [time, modifier] = time12.split(' ');
            let [hours, minutes] = time.split(':');
            if (hours === '12') hours = '00';
            if (modifier === 'PM') hours = parseInt(hours, 10) + 12;
            return `${hours.toString().padStart(2, '0')}:${minutes}`;
        };

        // =================================================================================
        // DATA & PROFILE MANAGEMENT
        // =================================================================================
        function saveSchedule() { localStorage.setItem('studyPlannerSchedule', JSON.stringify(schedule)); }
        function loadSchedule() { schedule = JSON.parse(localStorage.getItem('studyPlannerSchedule') || '{}'); }
        function saveUserProfile() { localStorage.setItem('studyPlannerProfile', JSON.stringify(userProfile)); }
        function loadUserProfile() {
            const profile = JSON.parse(localStorage.getItem('studyPlannerProfile'));
            userProfile = profile || { name: 'Priya Sharma', avatar: 'https://randomuser.me/api/portraits/women/44.jpg' };
            document.querySelector('.user-name').textContent = userProfile.name;
            document.querySelector('.avatar').src = userProfile.avatar;
        }
        function handleDailyReset() {
            const todayStr = formatDate(new Date());
            const lastVisitDate = localStorage.getItem('lastVisitDate');
            if (lastVisitDate && todayStr > lastVisitDate) {
                const lastDaySubjects = schedule[lastVisitDate] || [];
                if (lastDaySubjects.length > 0 && !schedule[todayStr]) {
                    schedule[todayStr] = lastDaySubjects.map(s => ({ ...s, tasks: [] }));
                    saveSchedule();
                }
            }
            localStorage.setItem('lastVisitDate', todayStr);
        }
        
        // =================================================================================
        // THEMES
        // =================================================================================
        const themes = {
            'Cosmic': { type: 'animated', '--primary': '#2c3e50', '--accent': '#8e44ad', '--card-header-bg': 'linear-gradient(-45deg, #2c3e50, #8e44ad, #2980b9, #3498db)', '--header-animation': 'animated-gradient 15s ease infinite' },
            'Aurora': { type: 'animated', '--primary': '#ff7e5f', '--accent': '#ffc3a0', '--card-header-bg': 'linear-gradient(-45deg, #00c6ff, #0072ff, #f09, #ff7e5f)', '--header-animation': 'animated-gradient 10s ease infinite' },
            'Ocean': { '--primary': '#4361ee', '--accent': '#4895ef' },
            'Sunset': { '--primary': '#f77f00', '--accent': '#fcbf49' },
            'Forest': { '--primary': '#2d6a4f', '--accent': '#52b788' },
            'Mango': { '--primary': '#ffe259', '--accent': '#ffb75e', '--card-header-bg': 'linear-gradient(to right, #ffe259, #ffa751)' },
            'Minty': { '--primary': '#00b09b', '--accent': '#48c9b0', '--card-header-bg': 'linear-gradient(to right, #00b09b, #96c93d)' },
            'Rose': { '--primary': '#e02d67', '--accent': '#f06292' },
            'Royal': { '--primary': '#4a00e0', '--accent': '#8e2de2', '--card-header-bg': 'linear-gradient(to right, #4a00e0, #8e2de2)' },
            'Teal': { '--primary': '#008080', '--accent': '#48D1CC' },
        };
        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            let finalTheme = {...theme};
            if (!finalTheme['--card-header-bg']) finalTheme['--card-header-bg'] = `linear-gradient(135deg, ${finalTheme['--accent']}, ${finalTheme['--primary']})`;
            if (!finalTheme['--header-animation']) finalTheme['--header-animation'] = 'none';
            Object.entries(finalTheme).forEach(([key, value]) => document.documentElement.style.setProperty(key, value));
            localStorage.setItem('studyPlannerTheme', themeName);
            document.querySelectorAll('.theme-option').forEach(opt => { if(opt) opt.classList.toggle('active', opt.dataset.theme === themeName); });
        }

        // =================================================================================
        // RENDER & UI FUNCTIONS
        // =================================================================================
        function renderSubjects() {
            const dateStr = formatDate(currentDate);
            document.getElementById('current-date-display').textContent = currentDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const subjectsForDate = schedule[dateStr] || [];
            const subjectsContainer = document.getElementById('subjects-container');
            subjectsContainer.innerHTML = '';
            if (subjectsForDate.length === 0) { subjectsContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #888;">No subjects scheduled. Click the '+' button to add one.</p>`; return; }
            subjectsForDate.forEach(subject => {
                const card = document.createElement('div');
                card.className = 'subject-card'; card.dataset.id = subject.id;
                card.innerHTML = `<div class="subject-header"><div class="subject-title-group"><h3>${subject.name}</h3><span class="subject-time">${subject.time}</span></div><div class="subject-actions"><button class="action-menu-btn" title="Actions"><i class="fas fa-ellipsis-v"></i></button><div class="actions-menu"><a href="#" class="edit-action"><i class="fas fa-edit"></i>Edit</a><a href="#" class="delete-action"><i class="fas fa-trash-alt"></i>Delete</a></div></div></div><div class="subject-body"><ul class="task-list">${subject.tasks.map(t => `<li class="task-item" data-task-id="${t.id}"><input type="checkbox" class="task-checkbox" ${t.completed ? 'checked' : ''}><span class="task-label ${t.completed ? 'completed' : ''}">${t.text}</span><button class="delete-task-btn" title="Delete Task"><i class="fas fa-times"></i></button></li>`).join('') || '<p style="text-align:center; color:#888; font-size:0.9rem; padding: 10px 0;">No tasks yet.</p>'}</ul><button class="show-add-task-btn"><i class="fas fa-plus"></i> Add Task</button><form class="add-task-form"><input type="text" class="task-input" placeholder="Add new task..." required><button type="submit" class="add-task-btn" title="Add Task"><i class="fas fa-plus"></i></button></form></div>`;
                subjectsContainer.appendChild(card);
            });
        }
        function renderCalendar() {
            calendarDate.setDate(1);
            const month = calendarDate.getMonth(), year = calendarDate.getFullYear();
            document.getElementById('month-year').textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const firstDayIndex = calendarDate.getDay(), lastDay = new Date(year, month + 1, 0).getDate(), prevLastDay = new Date(year, month, 0).getDate();
            const calendarDaysContainer = document.getElementById('calendar-days');
            calendarDaysContainer.innerHTML = '';
            for (let i = firstDayIndex; i > 0; i--) calendarDaysContainer.innerHTML += `<div class="calendar-day other-month">${prevLastDay - i + 1}</div>`;
            for (let i = 1; i <= lastDay; i++) {
                const dayDate = new Date(year, month, i), dateStr = formatDate(dayDate);
                calendarDaysContainer.innerHTML += `<div class="calendar-day ${schedule[dateStr] && schedule[dateStr].length > 0 ? 'has-subject' : ''} ${dateStr === formatDate(currentDate) ? 'selected' : ''}" data-date="${dateStr}">${i}</div>`;
            }
        }
        function switchView(viewName) {
            document.querySelectorAll('.main-content > div').forEach(v => v.style.display = 'none');
            document.getElementById(`${viewName}-view`).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.view === viewName));
            if (viewName === 'dashboard') renderSubjects();
            if (viewName === 'schedule') renderCalendar();
        }

        // =================================================================================
        // MODAL & FORM HANDLING
        // =================================================================================
        function openModal(type, data = null) {
            const form = document.getElementById('subject-form');
            form.reset();
            document.getElementById('modal-title').textContent = type === 'edit' ? 'Edit Subject' : 'Add New Subject';
            document.getElementById('submit-btn').textContent = type === 'edit' ? 'Save Changes' : 'Add Subject';
            document.getElementById('subject-id').value = type === 'edit' ? data.id : '';
            if (type === 'edit') {
                document.getElementById('subject-name').value = data.name;
                if (data.time && data.time.includes(' - ')) {
                    const [start, end] = data.time.split(' - ');
                    document.getElementById('subject-start-time').value = formatTimeForInput(start);
                    document.getElementById('subject-end-time').value = formatTimeForInput(end);
                }
            }
            subjectModal.style.display = 'flex';
        }
        function openSettingsModal() {
            document.getElementById('settings-content').innerHTML = `<div class="settings-section"><h4>Profile</h4><div class="form-group"><label for="candidate-name">Your Name</label><input type="text" id="candidate-name" class="form-input" value="${userProfile.name}"></div><button class="setting-btn" id="avatar-upload-btn">Change Profile Photo</button></div><div class="settings-section"><h4>Data Management</h4><button class="setting-btn" id="export-data">Export Data</button><button class="setting-btn" id="import-data">Import Data</button></div><div class="settings-section"><h4>Themes</h4><div class="theme-grid">${Object.keys(themes).map(name => `<div class="theme-option" data-theme="${name}"><div class="theme-name">${name}</div></div>`).join('')}</div></div>`;
            applyTheme(localStorage.getItem('studyPlannerTheme') || 'Cosmic');
            settingsModal.style.display = 'flex';
        }
        
        // =================================================================================
        // PRINT & EXPORT (FIXED)
        // =================================================================================
        function exportData() {
            const dataStr = JSON.stringify(schedule, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `study-planner-backup-${formatDate(new Date())}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function importData(file) {
            if(!file) return;
            if(!confirm('This will overwrite all current data. Are you sure?')) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedSchedule = JSON.parse(event.target.result);
                    schedule = importedSchedule;
                    saveSchedule(); alert('Data imported successfully!');
                    currentDate = new Date(); switchView('dashboard');
                } catch (error) { alert('Error: Invalid or corrupted data file.'); }
            };
            reader.readAsText(file);
        }
        function generatePrintContent(mode) {
            const printArea = document.getElementById('print-area');
            let html = `<h1>Study Plan</h1>`;
            const dataToPrint = (mode === 'selected') ? { [formatDate(currentDate)]: schedule[formatDate(currentDate)] || [] } : schedule;
            Object.keys(dataToPrint).sort().forEach(dateStr => {
                const subjects = dataToPrint[dateStr];
                if(subjects && subjects.length > 0) {
                     html += `<h2>${new Date(dateStr+'T00:00:00').toLocaleDateString('en-US', {dateStyle: 'full'})}</h2>`;
                     subjects.forEach(subject => {
                         html += `<div class="print-subject-card"><div class="print-subject-header"><span>${subject.name}</span><span>${subject.time}</span></div><ul class="print-task-list">${subject.tasks.map(t => `<li class="print-task-item ${t.completed ? 'completed' : ''}"><span>${t.text}</span></li>`).join('') || '<li>No tasks</li>'}</ul></div>`;
                     });
                }
            });
            if(html === `<h1>Study Plan</h1>`) html += `<p>No data to print for the selected range.</p>`;
            printArea.innerHTML = html;
            window.print();
        }
        
        // =================================================================================
        // EVENT LISTENERS
        // =================================================================================
        document.querySelector('.nav-menu').addEventListener('click', e => { const navItem = e.target.closest('.nav-item'); if (navItem && navItem.dataset.view) switchView(navItem.dataset.view); });
        document.getElementById('add-subject-btn').addEventListener('click', () => openModal('add'));
        document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
        document.getElementById('print-btn-nav').addEventListener('click', () => printModal.style.display = 'flex');
        
        document.getElementById('subject-form').addEventListener('submit', e => {
            e.preventDefault();
            const dateStr = formatDate(currentDate);
            if (!schedule[dateStr]) schedule[dateStr] = [];
            const id = parseInt(document.getElementById('subject-id').value);
            const startTime = document.getElementById('subject-start-time').value;
            const endTime = document.getElementById('subject-end-time').value;
            const subjectData = {
                name: document.getElementById('subject-name').value.trim(),
                time: `${formatTimeForDisplay(startTime)} - ${formatTimeForDisplay(endTime)}`
            };
            if (id) { Object.assign(schedule[dateStr].find(s => s.id === id), subjectData); } 
            else { schedule[dateStr].push({ id: Date.now(), ...subjectData, tasks: [] }); }
            saveSchedule(); renderSubjects(); subjectModal.style.display = 'none';
        });

        mainContent.addEventListener('click', e => {
            document.querySelectorAll('.actions-menu').forEach(menu => { if (!menu.parentElement.contains(e.target)) menu.style.display = 'none'; });
            const subjectCard = e.target.closest('.subject-card');
            if (e.target.closest('.show-add-task-btn')) { const btn = e.target.closest('.show-add-task-btn'); btn.style.display = 'none'; btn.nextElementSibling.style.display = 'flex'; btn.nextElementSibling.querySelector('input').focus(); }
            if (e.target.closest('.action-menu-btn')) { e.target.closest('.subject-actions').querySelector('.actions-menu').style.display = 'block'; }
            if (!subjectCard) return;
            const subjectId = parseInt(subjectCard.dataset.id), dateStr = formatDate(currentDate);
            const subject = schedule[dateStr].find(s => s.id === subjectId);
            if (e.target.matches('.edit-action')) openModal('edit', subject);
            if (e.target.matches('.delete-action')) { if (confirm('Delete this subject?')) { schedule[dateStr] = schedule[dateStr].filter(s => s.id !== subjectId); saveSchedule(); renderSubjects(); } }
            if (e.target.closest('.delete-task-btn')) { const taskId = parseInt(e.target.closest('.task-item').dataset.taskId); subject.tasks = subject.tasks.filter(t => t.id !== taskId); saveSchedule(); renderSubjects(); }
        });

        mainContent.addEventListener('change', e => {
            if(e.target.matches('.task-checkbox')) {
                const subjectId = parseInt(e.target.closest('.subject-card').dataset.id);
                const taskId = parseInt(e.target.closest('.task-item').dataset.taskId);
                const subject = schedule[formatDate(currentDate)].find(s => s.id === subjectId);
                const task = subject.tasks.find(t => t.id === taskId);
                task.completed = e.target.checked;
                saveSchedule(); renderSubjects();
            }
        });

        mainContent.addEventListener('submit', e => {
            if (e.target.classList.contains('add-task-form')) {
                e.preventDefault();
                const input = e.target.querySelector('.task-input');
                const subjectId = parseInt(e.target.closest('.subject-card').dataset.id);
                const subject = schedule[formatDate(currentDate)].find(s => s.id === subjectId);
                if (input.value.trim() && subject) { subject.tasks.push({ id: Date.now(), text: input.value.trim(), completed: false }); saveSchedule(); renderSubjects(); }
            }
        });

        document.getElementById('calendar-days').addEventListener('click', e => { if (e.target.classList.contains('calendar-day') && e.target.dataset.date) { const dateParts = e.target.dataset.date.split('-'); currentDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); switchView('dashboard'); } });
        document.getElementById('prev-month').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });
        
        document.body.addEventListener('click', e => {
            if (e.target.matches('.close-btn')) e.target.closest('.modal').style.display = 'none';
            if (e.target.matches('.modal')) e.target.style.display = 'none';
        });

        // Settings Listeners
        settingsModal.addEventListener('click', e => {
            if (e.target.closest('.theme-option')) applyTheme(e.target.closest('.theme-option').dataset.theme);
            if (e.target.id === 'export-data') exportData();
            if (e.target.id === 'import-data') document.getElementById('import-file-input').click();
            if (e.target.id === 'avatar-upload-btn' || e.target.closest('.avatar')) document.getElementById('avatar-upload').click();
        });
        settingsModal.addEventListener('change', e => { if(e.target.id === 'candidate-name') { userProfile.name = e.target.value; saveUserProfile(); loadUserProfile(); } });
        document.getElementById('avatar-upload').addEventListener('change', e => { if(e.target.files[0]) { const reader = new FileReader(); reader.onload = (event) => { userProfile.avatar = event.target.result; saveUserProfile(); loadUserProfile(); }; reader.readAsDataURL(e.target.files[0]); } });
        document.getElementById('import-file-input').addEventListener('change', e => importData(e.target.files[0]));
        printModal.addEventListener('click', e => { if (e.target.matches('.print-btn')) generatePrintContent(e.target.dataset.mode); });

        // =================================================================================
        // INITIALIZE APP
        // =================================================================================
        loadUserProfile();
        loadSchedule();
        handleDailyReset();
        applyTheme(localStorage.getItem('studyPlannerTheme') || 'Cosmic');
        switchView('dashboard');
    });
    </script>
</body>
</html>